<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>360° WebXR Viewer</title>
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.7.0/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
  <script src="stereo-sbs.js"></script>
  <style>
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
    #file-input { position: absolute; top: 10px; left: 10px; z-index: 1000; }
    #play-pause-btn {
      position: absolute; left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000; padding: 10px 20px;
      font-size: 16px; display: none;
    }
    #seek-bar {
      position: absolute; left: 50%; bottom: 5%;
      transform: translateX(-50%);
      z-index: 1000; width: 50%; display: none;
    }
    a-scene {
      width: 100%; height: 100%;
      position: absolute; top: 0; left: 0;
    }
    /* Custom VR button (recommended way: disable default UI and provide own) */
    #enter-vr-btn {
      position: fixed;
      left: 50%;
      bottom: calc(env(safe-area-inset-bottom, 0px) + 6vh);
      transform: translateX(-50%);
      z-index: 2000;
      padding: 10px 16px;
      font-size: 15px;
      border: none;
      border-radius: 6px;
      background: rgba(0,0,0,0.65);
      color: #fff;
      backdrop-filter: blur(2px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      cursor: pointer;
      display: none; /* shown when XR supported */
    }
    #enter-vr-btn:active { transform: translateX(-50%) scale(0.98); }
  </style>
</head>
<body>
  <input type="file" id="file-input" accept="image/*,video/*" />
  <button id="play-pause-btn">Play</button>
  <input type="range" id="seek-bar" min="0" max="100" step="0.1" value="0" />
  <pre id="folder-info" style="position:absolute; right:10px; top:10px; z-index:1000; background:rgba(0,0,0,0.5); color:#fff; padding:8px; margin:0; max-width:40vw; max-height:40vh; overflow:auto; font-size:12px; display:none"></pre>

  <a-scene background="color:#88c" embedded xr-mode-ui="enabled:false" isMobile="false">
    <a-assets>
      <img id="imageAsset" crossorigin="anonymous" />
      <video id="videoAsset" crossorigin="anonymous" webkit-playsinline playsinline  loop="false"></video>
    </a-assets>
    <a-entity id="camrig" rotation="0 180 0">
      <a-entity camera look-controls position="0 1.6 0"></a-entity>
      <a-entity id="lhand"
                hand-tracking-controls="hand: left;modelColor:#222;modelStyle:none"
                pinch-handler>
      </a-entity>
      <a-entity id="rhand"
                hand-tracking-controls="hand: right;modelColor:#222;modelStyle:none"
                pinch-handler>
      </a-entity>
      <a-entity id="left-controller" hand-controls="hand: left" controller-listener></a-entity>
      <a-entity id="right-controller" hand-controls="hand: right" controller-listener></a-entity>
    </a-entity>

    <a-sky id="sky" src="#imageAsset" visible="false" segments-height=50 segments-width=100></a-sky>
    <a-videosphere id="video-sphere" src="#videoAsset" loop="true" visible="false"></a-videosphere>
    <!-- Dedicated 180° sphere wedge for VR180 content -->
    <a-entity id="vr180-sphere"
              geometry="primitive: sphere; radius: 20; segmentsWidth: 100; segmentsHeight: 50; phiStart: 0; phiLength: 180; thetaStart: 0; thetaLength: 180"
              position="0 0 0"
              rotation="0 0 0"
              scale="1 -1 1"
              visible="false"
              stereo-sbs="monoEye: left; insideSphere: true"></a-entity>
    <!-- Stereo SBS flat plane for 2D SBS content -->
    <a-entity id="stereo-plane"
              geometry="primitive: plane; width: 1; height: 1"
              position="0 1.2 2.5"
              rotation="0 180 0"
              visible="false"
              stereo-sbs="monoEye: left; planeMode: true"></a-entity>
    <!-- Flat video plane for non-VR videos -->
    <a-entity id="video-plane"
              geometry="primitive: plane; width: 1; height: 1"
              material="src: #videoAsset; shader: flat; side: double"
              position="0 1.2 2.5"
              rotation="0 180 0"
              visible="false"></a-entity>
    <!-- Flat image plane for non-VR content -->
    <a-entity id="image-plane"
              geometry="primitive: plane; width: 1; height: 1"
              material="src: #imageAsset; shader: flat; side: double"
              position="0 1.2 2.5"
              rotation="0 180 0"
              visible="false"></a-entity>
  </a-scene>

  <!-- Custom VR button -->
  <button id="enter-vr-btn" aria-label="Enter VR">Enter VR</button>

  <script type="module" src="aframe-controls.js"></script>
  <script type="module" src="view.js"></script>
  <script>
    (function(){
      const sceneEl = document.querySelector('a-scene');
      const btn = document.getElementById('enter-vr-btn');
      if (!sceneEl || !btn) return;

      function updateVisibility() {
        if (!('xr' in navigator) || typeof navigator.xr.isSessionSupported !== 'function') {
          // Show button; A-Frame may still offer magic window or polyfills
          btn.style.display = 'block';
          return;
        }
        navigator.xr.isSessionSupported('immersive-vr').then((supported) => {
          btn.style.display = supported ? 'block' : 'none';
        }).catch(() => { btn.style.display = 'block'; });
      }

      btn.addEventListener('click', () => {
        if (sceneEl && typeof sceneEl.enterVR === 'function') {
          sceneEl.enterVR();
        }
      });

      sceneEl.addEventListener('enter-vr', () => { btn.style.display = 'none'; });
      sceneEl.addEventListener('exit-vr', updateVisibility);

      // Initial state
      updateVisibility();
    })();
  </script>

</body>
</html>
